<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <meta name="google" content="notranslate" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <title>测试获取pdf信息</title>
  </head>
  <body>
    <div id="mainDiv">
      <input
        type="button"
        id="uploadButton"
        value="点击上传PDF发票"
        onClick="upLoadClicked()"
      />
      <input
        id="selectFile"
        name="fileupload"
        type="file"
        value=""
        onchange="fileChange()"
        multiple
      />

      <div id="content">
        <div>
          请人工校验并核对输出内容，核对无误后即可<a
            href="javascript: void;"
            onClick="onDownloadXlsx()"
            >下载XLSX</a
          >
        </div>

        <pre
          id="jsonPreview"
          style="font-size: 12px; white-space: pre-wrap"
        ></pre>

        <!-- <div class="infoBox">
          <div>发票总金额</div>
          <div><textarea type="text" id="price" value="无"></textarea></div>
        </div>
        <div class="infoBox">
          <div>大写金额</div>
          <div><textarea type="text" id="daxie" value="无"></textarea></div>
        </div>
        <div class="infoBox">
          <div>我方公司</div>
          <div><textarea type="text" id="comp1" value="无"></textarea></div>
        </div>
        <div class="infoBox">
          <div>对方公司</div>
          <div><textarea type="text" id="comp2" value="无"></textarea></div>
        </div>
        <div class="infoBox">
          <div>发票代码</div>
          <div>
            <textarea type="text" id="invoiceCode" value="无"></textarea>
          </div>
        </div>
        <div class="infoBox">
          <div>发票号码</div>
          <div>
            <textarea type="text" id="invoiceNum" value="无"></textarea>
          </div>
        </div>
        <div class="infoBox">
          <div>开票时间</div>
          <div><textarea type="text" id="date" value="无"></textarea></div>
        </div> -->
      </div>
    </div>

    <!-- <iframe id="pdfViewer"></iframe> -->
  </body>
  <script type="text/javascript" src="./js/Tool.js"></script>
  <script type="text/javascript" src="./js/nzh.cn.min.js"></script>
  <!-- https://github.com/SheetJS/sheetjs -->
  <script type="text/javascript" src="./js/js-xlsx/xlsx.full.min.js"></script>
  <script type="text/javascript" src="../build/pdf.js"></script>
  <!--<script type="text/javascript" src="../build/pdf.worker.js"></script>-->
  <script>
    var INVOICE_TYPE_026 = "026";
    var INVOICE_TYPE_031 = "031";

    /* document.getElementById("pdfViewer").style.height =
      document.documentElement.clientHeight + "px"; */

    pdfjsLib.workerSrc = "../build/pdf.worker.js";
    //pdfjsLib.cMapUrl = 'cmaps/';
    //pdfjsLib.cMapPacked = true;
    var selectFile = document.getElementById("selectFile");
    function upLoadClicked() {
      this.document.getElementById("selectFile").click();
    }

    /**
     * 读取全电发票
     */
    function readAllEGeneral(pdfInfo) {
      const { pageWidth, pageHeight } = pdfInfo;

      const WIDTH = 595.276;
      const HEIGHT = 396.85;

      let invoiceType = "";
      let invoiceNo = "";
      let buyerCode = "";
      let buyerName = "";
      let sellerCode = "";
      let sellerName = "";
      let date = "";
      let amount = "";
      let invoiceDetail = "";

      pdfInfo.items.forEach((item, index) => {
        const x = (item.transform[4] / pageWidth) * WIDTH;
        const y = (item.transform[5] / pageHeight) * HEIGHT;

        console.log(x, y, item.str);

        if (index === 0) {
          invoiceType = item.str;
        } else if (x > 480 && y > 339 && y < 341) {
          date += item.str;
        } else if (/^\d{20}$/.test(item.str) && y > 356 && y < 358) {
          invoiceNo = item.str;
        } else if (x > 12 && x < 80 && y > 228 && y < 230) {
          invoiceDetail += item.str;
        } else if (x > 438 && y > 109 && y < 111) {
          amount += item.str;
        } else if (x > 151 && x < 154 && y > 262 && y < 264) {
          buyerCode = item.str;
        } else if (x > 56 && x < 58 && y > 292 && y < 294) {
          buyerName = item.str;
        } else if (x > 436 && x < 439 && y > 262 && y < 264) {
          sellerCode = item.str;
        } else if (x > 339 && x < 341 && y > 292 && y < 294) {
          sellerName = item.str;
        }
      });

      return {
        invoiceType,
        invoiceNo,
        date,
        amount: amount.replace(/[^0-9.]/g, ""),
        invoiceDetail,
        buyerCode,
        buyerName,
        sellerCode,
        sellerName,
      };
    }

    function readFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (args) => {
          resolve(args);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function getPDFInfo(readResult) {
      const pdfbase = readResult.target.result;

      const pdfData = atob(
        pdfbase.substr(pdfbase.indexOf("base64,") + 7, pdfbase.length)
      );

      const pdfjsLibInstance = pdfjsLib.getDocument({
        data: pdfData,
        cMapUrl: "https://cdn.jsdelivr.net/npm/pdfjs-dist@2.2.228/cmaps/",
        cMapPacked: true,
      });

      return new Promise((resolve, reject) => {
        pdfjsLibInstance.promise.then((pdf) => {
          pdf.getPage(1).then((page) => {
            // 获取本页长宽
            let pageWidth = page.getViewport().viewBox[2];
            let pageHeight = page.getViewport().viewBox[3];
            page.getTextContent().then((textContent) => {
              resolve({
                items: textContent.items,
                pageWidth,
                pageHeight,
              });
            });
          });
        });
      });
    }

    async function fileChange() {
      console.log("fileChange", selectFile.files);

      // let file = selectFile.files[0];

      const resultArr = [];

      for (const fileItem of selectFile.files) {
        let readResult = await readFile(fileItem);
        let pdfInfo = await getPDFInfo(readResult);
        let { items, pageWidth, pageHeight } = pdfInfo;
        console.log("getPDFInfo pageWidth", pageWidth);
        console.log("getPDFInfo pageHeight", pageHeight);
        console.log("getPDFInfo items", items);
        if (items.some((v) => v.str === "电子发票（普通发票）")) {
          const invoiceInfo = {
            ...readAllEGeneral(pdfInfo),
            fileName: fileItem.name,
          };
          resultArr.push(invoiceInfo);
        }
      }

      console.log("resultArr", resultArr);
      document.getElementById("jsonPreview").innerText = JSON.stringify(
        resultArr,
        null,
        2
      );
      localStorage.setItem("INVOICE_LIST", JSON.stringify(resultArr));

      return;

      let fileRender = new FileReader();
      fileRender.readAsDataURL(file);
      fileRender.onload = function (aaa) {
        // console.log(aaa.target.result,"这是base64流文件")
        sessionStorage.setItem("pdfBase64", aaa.target.result);
        let pdfbase = aaa.target.result;

        let pdfData = atob(
          pdfbase.substr(pdfbase.indexOf("base64,") + 7, pdfbase.length)
        );

        var loadingTask = pdfjsLib.getDocument({
          data: pdfData,
          cMapUrl: "https://cdn.jsdelivr.net/npm/pdfjs-dist@2.2.228/cmaps/",
          cMapPacked: true,
        });
        loadingTask.promise.then((pdf) => {
          console.info("pdf文件打印:", pdf);
          pdf.getPage(1).then((page) => {
            console.info("page1打印:", page);
            console.info("getAnnotations:", page.getAnnotations());
            console.info("getTextContent:", page.getTextContent());
            console.info("getViewport:", page.getViewport());
            console.info(
              "获取本页长款:",
              page.getViewport().viewBox[2],
              " * ",
              page.getViewport().viewBox[3]
            );
            console.info(
              "获取本页长款:",
              page.getViewport().width,
              " * ",
              page.getViewport().height
            );
            let pageWidth = page.getViewport().viewBox[2];
            let pageHeight = page.getViewport().viewBox[3];
            let invoiceInfo = {
              invoiceCode1: "",
              invoiceCode2: "",
              invoiceDate: "",
              Seller: "",
              buyer: "",
              price: "",
              daxie: "",
            };
            let tempDate = new Array();

            page.getTextContent().then(function (textContent) {
              console.info(textContent.items);

              if (
                textContent.items.some((v) => v.str === "电子发票（普通发票）")
              ) {
                const result = readAllEGeneral(textContent.items);
                console.log("全电普票", result);
                return;
              }

              textContent.items.forEach((element) => {
                if (
                  element.transform[4] / pageWidth > 470.57 / 610 &&
                  element.transform[5] / pageHeight > 357.9 / 394
                ) {
                  console.info("获取到发票代码：", element.str);
                  invoiceInfo.invoiceCode1 = element.str;
                }
                if (
                  element.transform[4] / pageWidth > 455 / 610 &&
                  element.transform[5] / pageHeight > 341 / 394 &&
                  element.transform[5] / pageHeight < 360.34 / 394
                ) {
                  console.info("获取到发票号码：", element.str);
                  invoiceInfo.invoiceCode2 = element.str;
                }
                if (
                  element.transform[4] / pageWidth > 100.46 / 610 &&
                  element.transform[4] / pageWidth < 339.31 / 610 &&
                  element.transform[5] / pageHeight > 285 / 394 &&
                  element.transform[5] / pageHeight < 306.99 / 394
                ) {
                  console.info(
                    element.transform[4],
                    pageWidth,
                    element.transform[4] / pageWidth
                  );
                  console.info("获取到购方名称", element.str);
                  invoiceInfo.buyer = element.str;
                }
                if (
                  element.transform[4] / pageWidth > 172 / 610 &&
                  element.transform[4] / pageWidth < 336 / 610 &&
                  element.transform[5] / pageHeight > 99 / 394 &&
                  element.transform[5] / pageHeight < 117 / 394
                ) {
                  console.info("大写金额", element.str);
                  invoiceInfo.daxie = element.str;
                }
                if (
                  element.transform[4] / pageWidth > 466 / 610 &&
                  element.transform[5] / pageHeight > 99 / 394 &&
                  element.transform[5] / pageHeight < 118 / 394
                ) {
                  console.info("小写金额", element.str);
                  invoiceInfo.price = element.str;
                }
                if (
                  element.transform[4] / pageWidth > 99.71 / 610 &&
                  element.transform[4] / pageWidth < 239.27 / 610 &&
                  element.transform[5] / pageHeight > 79.05 / 394 &&
                  element.transform[5] / pageHeight < 95 / 394
                ) {
                  console.info("获取到销方名称", element.str);
                  invoiceInfo.Seller = element.str;
                }
                if (
                  element.transform[4] / pageWidth > 456 / 610 &&
                  element.transform[5] / pageHeight > 330 / 394 &&
                  element.transform[5] / pageHeight < 349.32 / 394
                ) {
                  console.info("开票日期", element.str);
                  tempDate.push(element);
                }
              });

              let code1LabelIndex = "发票代码:";
              let code2LabelIndex = "发票号码:";
              textContent.items.forEach((item) => {
                if (
                  item.str == code1LabelIndex ||
                  item.str == code2LabelIndex
                ) {
                  console.info(item);
                  textContent.items.forEach((event) => {
                    if (
                      event.transform[4] > item.transform[4] + item.width &&
                      event.transform[5] > item.transform[5] - item.height &&
                      event.transform[5] < item.transform[5] + item.height
                    ) {
                      console.info(event);
                    }
                  });
                }
              });

              do {
                let maxX = 0;
                let maxIndex = 0;
                for (let i = 0; i < tempDate.length; i++) {
                  if (maxX < tempDate[i].transform[4]) {
                    maxX = tempDate[i].transform[4];
                    maxIndex = i;
                  }
                }
                //console.info(tempDate[maxIndex].str)
                invoiceInfo.invoiceDate =
                  tempDate[maxIndex].str.replace(/[^0-9]+/gi, "") +
                  invoiceInfo.invoiceDate;
                tempDate.splice(maxIndex, 1);
              } while (tempDate.length > 0);
              console.info("获取到的日期:", invoiceInfo.invoiceDate);
              setInvoiceText(invoiceInfo);
            });
          });
        });

        //console.info('loadingTask:',loadingTask)
        var url = selectFile.files[0].name;
        // window.location.href = "./viewer.html?file=file://" + url // 当前页打开
        //window.open("./viewer.html?file=" + url) // 新界面打开
        document.getElementById("pdfViewer").src = "./viewer.html";
        //console.info('子页面解析url地址为:',"./viewer.html?file=" + url)
      };
    }
    //从子页面获取到pdf信息
    function getPdfContent(args) {
      //console.info('获取到信息',args);
      /*
    console.info(prices)
    console.info(comp)
    console.info(code)
    */
      /*
    this.document.getElementById('content').innerHTML =
    '请查看下述文字是否正确修改后上报'+'</p>'+
    '识别到发票金额:'+prices[0]+'</p>'
    +'识别到数字金额:'+prices[1]+'</p>'
    +'识别到的公司1:'+comp[0]+'</p>'
    +'识别到的公司2:'+comp[1]+'</p>'
    +'发票代码:'+code[0]+'</p>'
    +'发票号码:'+code[1]
    */
      /*
  this.document.getElementById('price').value=prices[1]
  this.document.getElementById('daxie').value=prices[0]
  this.document.getElementById('comp1').value=comp[0]
  this.document.getElementById('comp2').value=comp[1]
  this.document.getElementById('invoiceCode').value=code[0]
  this.document.getElementById('invoiceNum').value=code[1]
  this.document.getElementById('date').value=code[2]
  */
    }

    function setInvoiceText(invoice) {
      this.document.getElementById("price").value = invoice.price;
      this.document.getElementById("daxie").value = invoice.daxie;
      this.document.getElementById("comp1").value = invoice.Seller;
      this.document.getElementById("comp2").value = invoice.buyer;
      this.document.getElementById("invoiceCode").value = invoice.invoiceCode1;
      this.document.getElementById("invoiceNum").value = invoice.invoiceCode2;
      this.document.getElementById("date").value = invoice.invoiceDate;
    }

    function onDownloadXlsx() {
      const invoiceListStr = localStorage.getItem("INVOICE_LIST");
      if (!invoiceListStr) {
        alert("请先上传PDF发票");
        return;
      }

      let invoiceList = [];
      try {
        invoiceList = JSON.parse(invoiceListStr);
      } catch (error) {
        console.error("本地存储的发票信息列表解析异常", error);
        alert("本地存储的发票信息列表解析异常" + error.message);
        return;
      }
      // 自定义表头
      const header = [
        "文件名称",
        "发票类型",
        "发票号码",
        "开票日期",
        "发票金额",
        "开票明细",
        "购方税号",
        "购方名称",
        "销售方税号",
        "销售方名称",
      ];
      // 自定义数据
      const data = invoiceList.map((item) => {
        return [
          item.fileName,
          item.invoiceType,
          item.invoiceNo,
          item.date,
          item.amount,
          item.invoiceDetail,
          item.buyerCode,
          item.buyerName,
          item.sellerCode,
          item.sellerName,
        ];
      });

      // js原生获取当前日期
      const date = new Date();
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const now = `${year}-${month}-${day}`;
      
      // 构建工作表
      const ws = XLSX.utils.aoa_to_sheet([header, ...data]);
      // 构建工作簿
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
      // 导出文件
      XLSX.writeFile(wb, now + "数据.xlsx");
    }
  </script>
</html>
